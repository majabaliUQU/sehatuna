<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة صحتنا | Sehatuna</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: IBM Plex Sans Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons: Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['IBM Plex Sans Arabic', 'sans-serif'],
                    },
                    colors: {
                        saudi: {
                            green: '#006C35', 
                            dark: '#004D26',  
                            light: '#CCE2D6', 
                            accent: '#A0CF3D',
                            gold: '#C6A664',
                        }
                    },
                    boxShadow: {
                        'card': '0 2px 8px rgba(0, 0, 0, 0.05)',
                        'card-hover': '0 8px 16px rgba(0, 0, 0, 0.08)',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F9FAFB; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .pulse-sos { animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        /* Updated Header Tabs */
        .nav-link {
            position: relative;
            font-weight: 500;
            color: #4B5563;
            padding: 0 1.5rem;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        
        .nav-link:hover {
            color: #006C35;
            background-color: #F3F4F6;
        }

        .nav-link.active {
            background-color: #004D26; 
            color: white;
            font-weight: 700;
        }
        
        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background-color: #25935F;
        }

        /* Card Styles */
        .service-card {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .service-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.06);
            border-color: #006C35;
        }

        /* Notifications */
        .notification-panel {
            position: absolute; top: 60px; left: 20px; width: 400px; max-height: 80vh;
            background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 100; overflow-y: auto;
            transform-origin: top left; opacity: 0; transform: scale(0.95); pointer-events: none;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .notification-panel.open { opacity: 1; transform: scale(1); pointer-events: auto; }
        @media (max-width: 640px) { .notification-panel { width: 90%; left: 5%; right: 5%; top: 70px; } }

        .alert-card {
            background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative; overflow: hidden; display: flex; border: 1px solid #f3f4f6; transition: transform 0.2s;
        }
        .alert-strip { width: 6px; flex-shrink: 0; }
        .alert-content { padding: 16px; flex-grow: 1; }
        .alert-flex { display: flex; align-items: flex-start; gap: 12px; }
        
        /* Footer */
        .footer-link { color: #D1D5DB; transition: color 0.2s; font-size: 14px; display: block; margin-bottom: 0.5rem; }
        .footer-link:hover { color: white; text-decoration: underline; }

        /* Progress Circle */
        .progress-circle { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; }
        .progress-circle::before { content: ""; position: absolute; inset: 0; border-radius: 50%; border: 4px solid #e5e7eb; }
        .progress-circle-value { position: absolute; font-size: 12px; font-weight: bold; }

        /* Checkbox day selection */
        .day-checkbox:checked + span { background-color: #006C35; color: white; border-color: #006C35; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .icon-std { font-size: 24px; } .icon-xl { font-size: 32px; }
        
        /* Gender Colors */
        .female-theme { border-color: #ec4899 !important; }
        .female-bg { background-color: #ec4899 !important; }
        .female-text { color: #db2777 !important; }
        .female-light { background-color: #fdf2f8 !important; color: #be185d !important; border-color: #fbcfe8 !important;}
        
        .male-theme { border-color: #2563eb !important; }
        .male-bg { background-color: #2563eb !important; }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col font-sans relative">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50 border-t-4 border-saudi-green">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-stretch h-20">
                <!-- Logos -->
                <div class="flex-shrink-0 flex items-center gap-3 cursor-pointer" onclick="navigate('dashboard')">
                    <div class="w-12 h-12 bg-green-50 rounded-full flex items-center justify-center text-saudi-green border border-green-100">
                        <i class="ph-fill ph-heartbeat text-3xl"></i>
                    </div>
                    <div class="flex flex-col"><span class="text-lg font-bold text-gray-900 leading-tight">منصة صحتنا</span></div>
                </div>

                <!-- Nav Desktop -->
                <div class="hidden md:flex flex-1 items-stretch justify-center gap-1 mx-4">
                    <button onclick="navigate('dashboard')" class="nav-link active group" data-target="dashboard">الرئيسية</button>
                    <button onclick="navigate('appointments')" class="nav-link group" data-target="appointments">المواعيد</button>
                    <button onclick="navigate('medications')" class="nav-link group" data-target="medications">الأدوية</button>
                    <button onclick="navigate('documents')" class="nav-link group" data-target="documents">الملف الطبي</button>
                    <button onclick="navigate('sands')" class="nav-link group" data-target="sands">المساندين</button>
                </div>

                <!-- Utils -->
                <div class="flex items-center gap-3 md:gap-5 relative">
                    <button onclick="toggleNotifications()" class="relative text-gray-600 hover:text-saudi-green transition-colors w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-50">
                        <i class="ph ph-bell icon-std"></i>
                        <span class="absolute top-2 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>
                    </button>
                    <!-- Profile -->
                    <div class="relative group">
                        <button class="flex items-center gap-2 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-full py-1.5 px-3 transition-colors">
                            <div class="w-8 h-8 rounded-full bg-saudi-green text-white flex items-center justify-center font-bold text-sm" id="current-profile-icon">س</div>
                            <div class="hidden md:block text-right"><span class="block text-xs font-bold text-gray-700" id="user-greeting-header">سارة</span></div>
                            <i class="ph ph-caret-down text-gray-400"></i>
                        </button>
                        <div class="absolute left-0 mt-2 w-72 bg-white rounded-xl shadow-xl border border-gray-100 hidden group-hover:block p-2 z-50 transform origin-top-left" id="profile-dropdown"></div>
                    </div>
                    <!-- Notification Panel -->
                    <div id="notification-panel" class="notification-panel">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
                            <h3 class="font-bold text-lg text-gray-800">التنبيهات</h3>
                            <button onclick="toggleNotifications()"><i class="ph-bold ph-x"></i></button>
                        </div>
                        <div class="p-4 space-y-4" id="notifications-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8 min-h-[60vh]">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 id="page-title" class="text-3xl font-bold text-gray-900 mb-1">ملخص اليوم</h1>
                <p id="page-subtitle" class="text-gray-500 text-sm">نظرة عامة على حالتك الصحية ومواعيدك القادمة</p>
            </div>
            <button class="bg-white text-red-600 px-5 py-2.5 rounded-lg hover:bg-red-50 transition flex items-center gap-2 font-bold pulse-sos shadow-sm border border-red-200" onclick="triggerSOS()">
                <i class="ph-fill ph-siren icon-std"></i> <span class="hidden md:inline">نداء استغاثة (SOS)</span>
            </button>
        </div>
        <div id="view-container" class="transition-opacity duration-300"></div>
    </div>

    <!-- Footer -->
    <footer class="bg-[#004D26] text-white pt-10 pb-6 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-8">
                 <!-- Right Side: Logo & Desc -->
                 <div class="text-center md:text-right">
                    <div class="flex items-center justify-center md:justify-start gap-3 mb-3">
                        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-[#004D26]">
                            <i class="ph-fill ph-heartbeat text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold">منصة صحتنا</h3>
                    </div>
                    <p class="text-sm text-gray-300 max-w-xs mx-auto md:mx-0 leading-relaxed">المنصة الوطنية الموحدة للرعاية الصحية، تمكنك من إدارة ملفك الصحي وملفات أفراد أسرتك بكل يسر وسهولة.</p>
                 </div>

                 <!-- Center: Quick Links -->
                 <div class="flex flex-wrap justify-center gap-6 md:gap-8 text-sm font-medium text-gray-200">
                     <a href="#" class="hover:text-[#A0CF3D] transition">عن المنصة</a>
                     <a href="#" class="hover:text-[#A0CF3D] transition">الأسئلة الشائعة</a>
                     <a href="#" class="hover:text-[#A0CF3D] transition">سياسة الخصوصية</a>
                     <a href="#" class="hover:text-[#A0CF3D] transition">شروط الاستخدام</a>
                     <a href="#" class="hover:text-[#A0CF3D] transition">اتصل بنا</a>
                 </div>

                 <!-- Left Side: Social -->
                 <div class="flex flex-col items-center md:items-end gap-4">
                     <div class="flex gap-4">
                     </div>
                 </div>
            </div>

            <!-- تم تعديل لون الخط الفاصل هنا -->
            <div class="border-t border-[#25935F] pt-6 flex flex-col md:flex-row justify-between items-center gap-4">
                <p class="text-xs text-gray-400">جميع الحقوق محفوظة © منصة صحتنا 2026</p>
                <div class="flex items-center gap-3 opacity-90 hover:opacity-100 transition">
                    <span class="text-xs text-gray-400">تحقيقاً لـ</span>
                    <div class="flex items-center gap-1 border border-white/20 rounded px-2 py-1 bg-[#004D26]">
                        <div class="w-2 h-2 rounded-full bg-[#C6A664]"></div>
                        <span class="font-bold text-white text-xs">رؤية السعودية 2030</span>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Mobile Nav -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around p-2 pb-safe z-30">
        <button onclick="navigate('dashboard')" class="nav-item active flex flex-col items-center gap-1 p-2 w-1/5" data-target="dashboard"><i class="ph ph-chart-pie-slice icon-std"></i><span class="text-[10px]">الرئيسية</span></button>
        <button onclick="navigate('appointments')" class="nav-item flex flex-col items-center gap-1 p-2 w-1/5" data-target="appointments"><i class="ph ph-calendar-check icon-std"></i><span class="text-[10px]">المواعيد</span></button>
        <div class="relative -top-6 w-1/5 flex justify-center"><button onclick="quickAdd()" class="w-12 h-12 bg-saudi-green rounded-full text-white shadow-lg flex items-center justify-center transform hover:scale-110"><i class="ph ph-plus icon-large"></i></button></div>
        <button onclick="navigate('medications')" class="nav-item flex flex-col items-center gap-1 p-2 w-1/5" data-target="medications"><i class="ph ph-pill icon-std"></i><span class="text-[10px]">الأدوية</span></button>
        <button onclick="navigate('sands')" class="nav-item flex flex-col items-center gap-1 p-2 w-1/5" data-target="sands"><i class="ph ph-users-three icon-std"></i><span class="text-[10px]">المساندين</span></button>
    </nav>

    <!-- Global Toast -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-2xl z-50 transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none flex items-center gap-3">
        <i class="ph-fill ph-check-circle text-green-400 icon-std"></i><span id="toast-message" class="font-medium text-sm">تم</span>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-lg overflow-hidden shadow-2xl transform scale-95 opacity-0 transition-all duration-300 max-h-[90vh] overflow-y-auto" id="modal-content"></div>
    </div>

    <script>
        // --- State Management ---
        const DEFAULT_STATE = {
            currentUser: "سارة", 
            currentProfile: "primary", 
            appointmentFilter: "upcoming",
            medicationFilter: "all",
            appointmentPatientFilter: "all",
            documentFilter: "all",
            documentSort: "newest",
            profiles: {
                primary: { 
                    id: 'primary', type: 'self', name: "سارة (أنا)", color: "bg-pink-600", gender: 'female',
                    relation: "أنا", conditions: ["حساسية"],
                    supporters: [
                        { id: 2, name: "أحمد (الأخ)", relation: "أخ", access: ["الكل"] },
                        { id: 3, name: "د. خالد", relation: "طبيب الأسرة", access: ["الكل"] }
                    ],
                    supporterRequests: [],
                    meds: [
                         { 
                            id: 201, name: "Zyrtec", type: "حبوب", dose: "10mg", 
                            freqType: "scheduled", freq: "مرة يومياً", times: ["21:00"], 
                            duration: "عند الحاجة", days: ["يومياً"],
                            stock: 10, totalStock: 20, taken: false, warning: false,
                            history: [],
                            missedInstruction: "خذها وقت التذكر",
                            image: null
                        }
                    ],
                    appointments: [
                         { id: 201, hospital: "مستشفى الولادة", clinic: "نساء وولادة", doctor: "د. نورة", spec: "نساء", date: "2026-02-01", time: "11:00", sand: "لا يوجد", condition: "متابعة حمل", done: false },
                         { id: 202, hospital: "عيادات دلة", clinic: "الأسنان", doctor: "د. محمد", spec: "أسنان", date: "2026-02-15", time: "16:30", sand: "لا يوجد", condition: "تنظيف دوري", done: false },
                         { id: 203, hospital: "مستشفى الحبيب", clinic: "الجلدية", doctor: "د. سارة", spec: "جلدية", date: "2026-03-02", time: "09:00", sand: "لا يوجد", condition: "استشارة", done: false }
                    ],
                    documents: []
                },
                proxy1: {
                    id: 'proxy1', type: 'proxy', name: "الوالد (عبدالله)", color: "bg-blue-600", gender: 'male',
                    relation: "الوالد", role: "sanad", // تم التعديل إلى مساند
                    conditions: ["السكري", "الضغط", "العيون"],
                    meds: [
                        { 
                            id: 101, name: "Metformin", type: "حبوب", dose: "850mg", 
                            freqType: "scheduled", freq: "مرتين يومياً", times: ["08:00", "20:00"], 
                            duration: "30 يوم", days: ["السبت", "الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"],
                            stock: 3, totalStock: 60, taken: false, warning: true,
                            history: [{date:'2023-12-14', status:'taken'}, {date:'2023-12-13', status:'taken'}, {date:'2023-12-12', status:'missed'}],
                            missedInstruction: "إذا مر أكثر من ساعتين على موعد الجرعة، تخطها وانتظر الجرعة القادمة.",
                            image: null
                        }
                    ],
                    appointments: [
                        { id: 101, hospital: "مستشفى الحرس", clinic: "عيادة السكري", doctor: "د. منى الغامدي", spec: "غدد صماء", date: "2026-01-15", time: "09:30", sand: "مطلوب مرافق", condition: "متابعة السكري", instructions: "صيام 12 ساعة", done: false },
                        { id: 103, hospital: "مركز الأشعة الدولي", clinic: "قسم الأشعة", doctor: "", spec: "أشعة", date: "2026-01-20", time: "16:00", sand: "أنا", condition: "آلام الظهر", done: false },
                        { id: 104, hospital: "عيادة القلب", clinic: "القلب", doctor: "د. سمير", spec: "قلب", date: "2026-02-10", time: "10:00", sand: "مطلوب مرافق", condition: "مراجعة", done: false },
                        { id: 105, hospital: "مستشفى العيون", clinic: "الشبكية", doctor: "د. عصام", spec: "عيون", date: "2026-03-05", time: "08:30", sand: "مطلوب مرافق", condition: "حقن شبكية", done: false },
                        { id: 102, hospital: "مستشفى العيون", clinic: "العيون", doctor: "د. سالم", spec: "عيون", date: "2023-10-10", time: "08:00", sand: "أحمد (أنا)", condition: "فحص دوري", done: true }
                    ],
                    documents: [
                        { id: 101, title: "تقرير أشعة الصدر", type: "report", date: "2023-12-05", file: "xray.jpg", desc: "متابعة حالة الربو" }
                    ]
                },
                proxy_ahmed: {
                    id: 'proxy_ahmed', type: 'proxy', name: "أحمد (الأخ)", color: "bg-saudi-green", gender: 'male',
                    relation: "أخ", role: "sanad", // تم التعديل إلى مساند (افتراضياً للأخوة)
                    conditions: ["الضغط"],
                    meds: [
                         { 
                             id: 1, name: "بنادول إكسترا", type: "حبوب", dose: "500mg", 
                             freqType: "prn", freq: "عند اللزوم", times: [], duration: "مستمر", 
                             stock: 20, totalStock: 30, taken: false, 
                             history: [{date:'2023-12-10', status:'taken'}],
                             missedInstruction: "يمكن أخذ الجرعة في أي وقت عند الشعور بالألم.",
                             image: null
                         }
                    ],
                    appointments: [
                        { id: 1, hospital: "عيادات الماسة", clinic: "عيادة الأسنان", doctor: "د. خالد السعيد", spec: "أسنان", date: "2026-01-10", time: "10:00", sand: "لا يوجد", condition: "تنظيف دوري", done: false },
                        { id: 2, hospital: "النادي الصحي", clinic: "العلاج الطبيعي", doctor: "أ. فهد", spec: "علاج طبيعي", date: "2026-01-15", time: "17:00", sand: "لا يوجد", condition: "إصابة رياضية", done: false },
                        { id: 99, hospital: "مستشفى التخصصي", clinic: "عيادة الباطنية", doctor: "د. فهد", spec: "باطنية", date: "2026-02-05", time: "09:00", sand: "لا يوجد", condition: "فحص دوري", done: false }
                    ],
                    documents: [
                        { id: 1, title: "تحليل دم شامل", type: "lab", date: "2023-11-10", file: "report.pdf", desc: "فحص دوري سنوي" }
                    ]
                },
                proxy_mother: {
                    id: 'proxy_mother', type: 'proxy', name: "نورة (الوالدة)", color: "bg-pink-500", gender: 'female', 
                    relation: "الوالدة", role: "sanad", // تم التعديل إلى مساند
                    conditions: ["ضغط", "هشاشة عظام"],
                    meds: [
                        { 
                            id: 301, name: "Calcium + Vit D", type: "حبوب", dose: "600mg", 
                            freqType: "scheduled", freq: "مرة يومياً", times: ["10:00"], 
                            duration: "مستمر", days: ["يومياً"],
                            stock: 25, totalStock: 30, taken: false, warning: false,
                            history: [],
                            missedInstruction: "خذها مع وجبة الغداء",
                            image: null
                        }
                    ],
                    appointments: [
                         { id: 301, hospital: "مدينة الملك فهد", clinic: "العظام", doctor: "د. سعاد", spec: "عظام", date: "2026-01-12", time: "08:30", sand: "مطلوب مرافق", condition: "متابعة هشاشة", done: false },
                         { id: 302, hospital: "مركز السكري", clinic: "التثقيف الصحي", doctor: "أ. ليلى", spec: "تثقيف", date: "2026-01-25", time: "10:00", sand: "سارة (أنا)", condition: "حمية غذائية", done: false }
                    ],
                    documents: []
                },
                proxy_laila: { // Added Laila with Supporters
                    id: 'proxy_laila', type: 'proxy', name: "ليلى (الابنة)", color: "bg-pink-400", gender: 'female', // تم تغيير اللون هنا
                    relation: "ابنة", role: "wakeel", // ابنة قاصر (وكيل)
                    conditions: ["تطعيمات", "ربو بسيط"],
                    supporters: [
                        { id: 101, name: "نورة (الجدة)", relation: "جدة", access: ["المواعيد", "الأدوية"] },
                        { id: 999, name: "سارة (الأم)", relation: "أم / وكيل", access: ["صلاحية كاملة"] }
                    ],
                    meds: [
                        { 
                            id: 401, name: "خافض حرارة (فيفادول)", type: "شراب", dose: "5ml", 
                            freqType: "prn", freq: "عند اللزوم", times: [], 
                            duration: "عند الحاجة", days: ["يومياً"],
                            stock: 1, totalStock: 1, taken: false, warning: false,
                            history: [],
                            missedInstruction: "لا تتجاوز 4 جرعات يومياً",
                            image: null
                        }
                    ],
                    appointments: [
                         { id: 401, hospital: "مركز صحي الحي", clinic: "الطفل السليم", doctor: "د. هدى", spec: "أطفال", date: "2026-02-20", time: "09:00", sand: "سارة (أنا)", condition: "تطعيم 4 سنوات", done: false }
                    ],
                    documents: []
                }
            }
        };

        let state = {};

        function loadState() {
            const stored = localStorage.getItem('sehatuna_state_v19_laila_pink'); // Version bump for Laila Color
            if (stored) state = JSON.parse(stored);
            else { state = JSON.parse(JSON.stringify(DEFAULT_STATE)); saveState(); }
        }
        function saveState() { localStorage.setItem('sehatuna_state_v19_laila_pink', JSON.stringify(state)); renderProfileDropdown(); updateHeader(); }

        document.addEventListener('DOMContentLoaded', () => {
            loadState(); navigate('dashboard'); updateHeader(); renderProfileDropdown(); renderNotifications();
        });

        // --- Navigation ---
        function navigate(viewId) {
            document.querySelectorAll('.nav-link, .nav-item').forEach(el => {
                el.classList.remove('active');
                if (el.dataset.target === viewId) el.classList.add('active');
            });

            const container = document.getElementById('view-container');
            container.style.opacity = '0';
            setTimeout(() => {
                let html = '';
                const titles = { 'dashboard': 'ملخص اليوم', 'appointments': 'المواعيد', 'medications': 'الأدوية', 'documents': 'الملف الطبي', 'sands': 'المساندين' };
                const subtitles = {
                    'dashboard': 'نظرة عامة على حالتك الصحية ومواعيدك القادمة',
                    'appointments': 'جدول المواعيد الطبية والفحوصات',
                    'medications': 'إدارة الأدوية والجرعات اليومية',
                    'documents': 'السجلات والتقارير الطبية',
                    'sands': 'إدارة المتابعين والمرضى'
                };

                if(document.getElementById('page-title')) document.getElementById('page-title').innerText = titles[viewId];
                if(document.getElementById('page-subtitle')) document.getElementById('page-subtitle').innerText = subtitles[viewId];

                const isProxy = state.currentProfile !== 'primary';
                const profile = state.profiles[state.currentProfile];
                const themeClass = profile.gender === 'female' ? 'bg-pink-50 border-pink-500 text-pink-600' : 'bg-amber-50 border-amber-500 text-amber-600';
                const iconBg = profile.gender === 'female' ? 'bg-pink-100 text-pink-600' : 'bg-amber-100 text-amber-600';
                
                // Determine Role Text (Sanad or Wakeel)
                const roleText = profile.role === 'sanad' ? 'وضع المساند (صلاحيات مخصصة)' : 'وضع الوكيل (صلاحية كاملة)';
                const roleIcon = profile.role === 'sanad' ? 'ph-hand-heart' : 'ph-user-switch';

                const profileHeader = isProxy ? `<div class="${themeClass} border-r-4 p-4 rounded-lg shadow-sm mb-6 flex justify-between animate-pulse"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full ${iconBg} flex items-center justify-center"><i class="ph-fill ${roleIcon} icon-std"></i></div><div><h3 class="font-bold text-gray-900">أنت تتصفح ملف: ${state.profiles[state.currentProfile].name}</h3><p class="text-xs text-gray-600">${roleText}</p></div></div><button onclick="switchProfile('primary')" class="text-xs font-bold bg-white/50 px-3 py-1.5 rounded border border-black/5 hover:bg-white transition">العودة</button></div>` : '';

                switch(viewId) {
                    case 'dashboard': html = profileHeader + renderDashboard(); break;
                    case 'appointments': html = profileHeader + renderAppointmentsPage(); break;
                    case 'medications': html = profileHeader + renderMedicationsPage(); break;
                    case 'documents': html = profileHeader + renderDocumentsPage(); break;
                    case 'sands': html = profileHeader + renderSandsPage(); break;
                }
                container.innerHTML = html;
                container.style.opacity = '1';
            }, 150);
        }

        // --- Renderers ---

        function renderDashboard() {
            let allAppointments = [];
            let allMeds = [];
            Object.keys(state.profiles).forEach(key => {
                const profile = state.profiles[key];
                if (key === state.currentProfile || state.currentProfile === 'primary') { // Show only relevant items if in proxy mode
                    profile.appointments.forEach(app => {
                        if (!app.done) allAppointments.push({ ...app, profileName: profile.name, profileColor: profile.color, profileKey: key, profileType: profile.type });
                    });
                    profile.meds.forEach(med => {
                        allMeds.push({ ...med, profileName: profile.name, profileColor: profile.color, profileKey: key });
                    });
                }
            });
            // If viewing a proxy profile, filter to show ONLY their items
            if(state.currentProfile !== 'primary') {
                allAppointments = allAppointments.filter(a => a.profileKey === state.currentProfile);
                allMeds = allMeds.filter(m => m.profileKey === state.currentProfile);
            }
            
            allAppointments.sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-12">
                    <div><div class="flex items-center justify-between mb-6"><h2 class="text-2xl font-bold text-gray-800 border-r-4 border-saudi-green pr-4">الأدوية المستحقة</h2></div>${allMeds.length === 0 ? `<div class="bg-white border border-dashed border-gray-300 rounded-xl p-12 text-center text-gray-500">لا توجد أدوية</div>` : `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${allMeds.map(med => renderMedicationCard(med, false)).join('')}</div>`}</div>
                    <div><div class="flex items-center justify-between mb-6"><h2 class="text-2xl font-bold text-gray-800 border-r-4 border-saudi-green pr-4">المواعيد القادمة</h2><button onclick="navigate('appointments')" class="text-saudi-green font-bold text-sm hover:underline">عرض الكل</button></div>${allAppointments.length === 0 ? `<div class="bg-white border border-dashed border-gray-300 rounded-xl p-12 text-center text-gray-500">لا توجد مواعيد قادمة</div>` : `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${allAppointments.map(app => renderAppointmentCard(app)).join('')}</div>`}</div>
                </div>
            `;
        }

        function renderSandsPage() {
            const isPrimary = state.currentProfile === 'primary';
            const currentProfileObj = state.profiles[state.currentProfile];
            
            // Only primary user 'supports' people in this context (proxies)
            const peopleISupport = isPrimary ? Object.values(state.profiles).filter(p => p.type === 'proxy') : [];
            
            // Supporters list depends on who we are viewing
            const mySupporters = currentProfileObj.supporters || [];
            const myRequests = isPrimary ? (currentProfileObj.supporterRequests || []) : [];

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-12">
                    ${isPrimary ? `
                    <!-- Section 1: People I Support -->
                    <section>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 border-r-4 border-saudi-green pr-4">أشخاص أساندهم (رعايتي)</h2>
                            <button onclick="openModal('add-patient')" class="bg-saudi-green text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-green-800 transition">
                                <i class="ph-bold ph-user-plus"></i> إضافة مريض
                            </button>
                        </div>
                        
                        ${peopleISupport.length === 0 ? 
                            `<div class="bg-white border border-dashed border-gray-300 rounded-xl p-12 text-center text-gray-500">لا يوجد أشخاص تتابعهم حالياً</div>` :
                            `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${peopleISupport.map(person => renderPersonISupportCard(person)).join('')}
                            </div>`
                        }
                    </section>` : ''}

                    <!-- Section 2: Supporters -->
                    <section>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 border-r-4 border-blue-600 pr-4">
                                ${isPrimary ? 'فريق مساندتي' : `فريق مساندة ${currentProfileObj.name}`}
                            </h2>
                            <button onclick="openModal('add-supporter')" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-gray-50 transition">
                                <i class="ph-bold ph-users-three"></i> دعوة مساند
                            </button>
                        </div>

                        <!-- Pending Requests -->
                        ${myRequests.length > 0 ? `
                            <div class="mb-6 space-y-4">
                                <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                                    <h3 class="text-sm font-bold text-amber-800 mb-3 flex items-center gap-2"><i class="ph-fill ph-bell-ringing"></i> طلبات المتابعة المعلقة</h3>
                                    <div class="space-y-2">
                                        ${myRequests.map(req => `
                                            <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center text-amber-600 font-bold">${req.name.charAt(0)}</div>
                                                    <div>
                                                        <p class="font-bold text-sm text-gray-800">${req.name}</p>
                                                        <p class="text-xs text-gray-500">${req.relation} • ${req.access}</p>
                                                    </div>
                                                </div>
                                                <div class="flex gap-2">
                                                    <button onclick="acceptRequest(${req.id})" class="text-xs bg-saudi-green text-white px-3 py-1.5 rounded font-bold">قبول</button>
                                                    <button onclick="rejectRequest(${req.id})" class="text-xs bg-red-50 text-red-600 px-3 py-1.5 rounded font-bold border border-red-100">رفض</button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${mySupporters.length === 0 ? 
                                `<div class="col-span-full text-center py-8 text-gray-400 border border-dashed rounded-xl">لا يوجد مساندين لهذا الملف</div>` :
                                mySupporters.map(supporter => `
                                <div class="service-card relative">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 font-bold text-lg">${supporter.name.charAt(0)}</div>
                                            <div>
                                                <h3 class="font-bold text-gray-900">${supporter.name}</h3>
                                                <p class="text-sm text-gray-500">${supporter.relation}</p>
                                            </div>
                                        </div>
                                        ${isPrimary ? `<button class="text-gray-400 hover:text-gray-600"><i class="ph-bold ph-dots-three-vertical text-xl"></i></button>` : ''}
                                    </div>
                                    <div class="mb-4">
                                        <p class="text-xs text-gray-400 mb-2">صلاحيات الوصول:</p>
                                        <div class="flex flex-wrap gap-1">
                                            ${supporter.access.map(tag => `<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-[10px] border border-gray-200">${tag}</span>`).join('')}
                                        </div>
                                    </div>
                                    ${isPrimary ? `
                                    <div class="flex gap-2 mt-auto pt-4 border-t border-gray-100">
                                        <button onclick="openModal('edit-permissions', ${supporter.id})" class="flex-1 text-xs font-bold text-gray-600 py-2 hover:bg-gray-50 rounded bg-white border border-gray-200">تعديل الصلاحيات</button>
                                        <button onclick="deleteSupporter(${supporter.id})" class="px-3 text-red-500 hover:bg-red-50 rounded border border-red-100"><i class="ph-bold ph-trash"></i></button>
                                    </div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </section>
                </div>
            `;
        }

        function renderPersonISupportCard(person) {
            // Check for Alerts
            const alerts = [];
            const isFemale = person.gender === 'female';
            
            // Meds Alerts
            person.meds.forEach(m => {
                if (m.stock < 5) alerts.push({icon: 'ph-pill', text: `نفاذ ${m.name}`, color: 'text-red-600'});
                const lastHistory = m.history[m.history.length-1];
                if (lastHistory && lastHistory.status === 'missed') alerts.push({icon: 'ph-warning', text: `لم يأخذ ${m.name}`, color: 'text-red-600'});
            });

            // Appointment Alerts
            person.appointments.forEach(a => {
                if (a.sand === 'مطلوب مرافق' && !a.done) alerts.push({icon: 'ph-users', text: `موعد يحتاج مرافق`, color: 'text-amber-600'});
            });

            const roleBadge = person.role === 'sanad' 
                ? `<span class="bg-blue-50 text-blue-700 text-[10px] px-2 py-0.5 rounded border border-blue-100">مساند</span>` 
                : `<span class="bg-purple-50 text-purple-700 text-[10px] px-2 py-0.5 rounded border border-purple-100">وكيل شرعي</span>`;

            return `
                <div class="service-card group border-t-4 ${isFemale ? 'female-theme' : 'male-theme'} cursor-pointer" onclick="switchProfile('${person.id}')">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full ${isFemale ? 'female-bg' : 'male-bg'} text-white flex items-center justify-center font-bold text-lg shadow-sm border-2 border-white ring-2 ring-gray-100">
                                <i class="ph-fill ${isFemale ? 'ph-user' : 'ph-user'}"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-gray-900">${person.name}</h3>
                                <p class="text-sm text-gray-500 flex items-center gap-2">${person.relation} ${roleBadge}</p>
                            </div>
                        </div>
                        <i class="ph-bold ph-arrow-left text-gray-300 group-hover:text-saudi-green transition-colors"></i>
                    </div>

                    <div class="mb-4 space-y-2">
                        <div class="text-xs text-gray-500 flex items-center gap-2">
                            <i class="ph-fill ph-activity ${isFemale ? 'female-text' : 'text-saudi-green'}"></i>
                            <span>الحالات: <b>${person.conditions ? person.conditions.join('، ') : 'عام'}</b></span>
                        </div>
                    </div>

                    <!-- Alerts Section -->
                    ${alerts.length > 0 ? `
                        <div class="bg-red-50 border border-red-100 rounded-lg p-3 mb-4 space-y-2">
                            ${alerts.map(alert => `
                                <div class="flex items-center gap-2 text-xs font-bold ${alert.color}">
                                    <i class="ph-fill ${alert.icon}"></i> ${alert.text}
                                </div>
                            `).join('')}
                        </div>
                    ` : `<div class="${isFemale ? 'female-light' : 'bg-green-50 border-green-100 text-green-700'} border rounded-lg p-3 mb-4 text-xs font-bold flex items-center gap-2"><i class="ph-fill ph-check-circle"></i> الحالة مستقرة</div>`}

                    <button class="w-full bg-gray-50 hover:bg-gray-100 text-gray-700 font-bold py-2 rounded-lg text-sm border border-gray-200 transition">
                        فتح الملف
                    </button>
                </div>
            `;
        }

        // ... (Render Documents & Medications Page) ...
        function renderDocumentsPage() {
            let docs = [];
            if (state.documentFilter === 'all') { Object.keys(state.profiles).forEach(key => { const p = state.profiles[key]; p.documents.forEach(d => docs.push({...d, profileName: p.name, profileColor: p.color, profileKey: key})); }); } 
            else { const p = state.profiles[state.documentFilter]; if(p) p.documents.forEach(d => docs.push({...d, profileName: p.name, profileColor: p.color, profileKey: state.documentFilter})); }
            docs.sort((a, b) => { const dateA = new Date(a.date); const dateB = new Date(b.date); return state.documentSort === 'newest' ? dateB - dateA : dateA - dateB; });
            return `<div class="fade-in max-w-7xl mx-auto"><div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4"><div class="flex flex-wrap gap-2 bg-gray-100 p-1 rounded-lg"><button onclick="setDocFilter('all')" class="px-4 py-2 rounded-md text-sm font-bold transition ${state.documentFilter === 'all' ? 'bg-white shadow-sm text-saudi-green' : 'text-gray-500'}">الكل</button>${Object.values(state.profiles).map(p => `<button onclick="setDocFilter('${p.id}')" class="px-4 py-2 rounded-md text-sm font-bold transition ${state.documentFilter === p.id ? 'bg-white shadow-sm text-saudi-green' : 'text-gray-500'}">${p.id === 'primary' ? 'ملفاتي' : p.name}</button>`).join('')}</div><div class="flex gap-2 w-full md:w-auto"><button onclick="toggleDocSort()" class="bg-white border border-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-gray-50"><i class="ph-bold ${state.documentSort === 'newest' ? 'ph-sort-descending' : 'ph-sort-ascending'}"></i> ${state.documentSort === 'newest' ? 'الأحدث' : 'الأقدم'}</button><button onclick="openModal('add-document')" class="bg-saudi-green text-white px-5 py-2.5 rounded-lg font-bold shadow-sm hover:bg-green-800 transition flex items-center gap-2 flex-1 justify-center md:flex-none"><i class="ph-bold ph-upload-simple"></i> إضافة ملف</button></div></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${docs.length === 0 ? `<div class="col-span-full text-center py-16 text-gray-400 border-2 border-dashed border-gray-200 rounded-xl bg-gray-50"><i class="ph ph-files text-4xl mb-2 block mx-auto opacity-50"></i>لا توجد مستندات</div>` : ''}${docs.map(doc => `<div class="service-card group relative"><div class="flex justify-between items-start mb-4"><div class="bg-gray-50 p-3 rounded-lg border border-gray-100 text-saudi-green"><i class="ph-fill ${doc.type === 'lab' ? 'ph-flask' : doc.type === 'rx' ? 'ph-prescription' : 'ph-file-text'} icon-large"></i></div><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold ${doc.profileColor} text-white gap-1"><i class="ph-fill ph-user"></i> ${doc.profileName}</span></div><h3 class="text-lg font-bold text-gray-900 mb-1">${doc.title}</h3><p class="text-sm text-gray-500 mb-4 line-clamp-2">${doc.desc}</p><div class="flex items-center gap-2 text-xs text-gray-400 mt-auto"><i class="ph-fill ph-calendar-blank"></i> ${doc.date}</div><div class="absolute top-4 left-4 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="deleteDocument('${doc.profileKey}', ${doc.id})" class="text-red-400 hover:text-red-600 p-1 bg-white rounded shadow-sm border border-gray-100"><i class="ph-bold ph-trash"></i></button></div></div>`).join('')}</div></div>`;
        }

        function renderMedicationsPage() {
            let meds = [];
            if (state.medicationFilter === 'all') { Object.keys(state.profiles).forEach(key => { const p = state.profiles[key]; p.meds.forEach(m => meds.push({...m, profileName: p.name, profileColor: p.color, profileKey: key})); }); } else { const p = state.profiles[state.medicationFilter]; if(p) p.meds.forEach(m => meds.push({...m, profileName: p.name, profileColor: p.color, profileKey: state.medicationFilter})); }
            return `<div class="fade-in max-w-7xl mx-auto"><div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4"><div class="flex gap-2 bg-gray-100 p-1 rounded-lg overflow-x-auto max-w-full"><button onclick="setMedFilter('all')" class="px-4 py-2 rounded-md text-sm font-bold transition whitespace-nowrap ${state.medicationFilter === 'all' ? 'bg-white shadow-sm text-saudi-green' : 'text-gray-500'}">الكل</button>${Object.values(state.profiles).map(p => `<button onclick="setMedFilter('${p.id}')" class="px-4 py-2 rounded-md text-sm font-bold transition whitespace-nowrap ${state.medicationFilter === p.id ? 'bg-white shadow-sm text-saudi-green' : 'text-gray-500'}">${p.id === 'primary' ? 'أدويتي' : p.name}</button>`).join('')}</div><button onclick="openModal('add-medication')" class="bg-saudi-green text-white px-5 py-2.5 rounded-lg font-bold shadow-sm hover:bg-green-800 transition flex items-center gap-2"><i class="ph-bold ph-plus"></i> إضافة دواء</button></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${meds.length === 0 ? `<div class="col-span-full text-center py-12 text-gray-400">لا توجد أدوية مسجلة</div>` : ''}${meds.map(med => renderMedicationCard(med, true)).join('')}</div></div>`;
        }

        function renderAppointmentsPage() {
            const now = new Date(); let allApps = []; Object.keys(state.profiles).forEach(key => { const profile = state.profiles[key]; profile.appointments.forEach(app => { allApps.push({ ...app, profileName: profile.name, profileColor: profile.color, profileKey: key, profileType: profile.type }); }); });
            if (state.appointmentPatientFilter !== 'all') { allApps = allApps.filter(app => app.profileKey === state.appointmentPatientFilter); }
            const upcomingApps = allApps.filter(app => new Date(app.date + 'T' + app.time) >= now).sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
            const pastApps = allApps.filter(app => new Date(app.date + 'T' + app.time) < now).sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));
            const displayedApps = state.appointmentFilter === 'upcoming' ? upcomingApps : pastApps;
            // Stats
            const totalUpcoming = upcomingApps.length; const needsSandCount = upcomingApps.filter(a => a.sand === 'مطلوب مرافق' || a.sand === 'لا يوجد').length; const pastAccompaniedCount = allApps.filter(a => a.sand.includes(state.currentUser) && a.done).length;
            return `<div class="fade-in max-w-7xl mx-auto"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"><div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between"><div><p class="text-xs text-gray-500 mb-1">مواعيد قادمة</p><p class="text-2xl font-bold">${totalUpcoming}</p></div><div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i class="ph-fill ph-calendar-check icon-std"></i></div></div><div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between"><div><p class="text-xs text-gray-500 mb-1">تتطلب مرافق</p><p class="text-2xl font-bold ${needsSandCount > 0 ? 'text-red-600' : ''}">${needsSandCount}</p></div><div class="w-10 h-10 rounded-full bg-red-50 text-red-600 flex items-center justify-center"><i class="ph-fill ph-users icon-std"></i></div></div><div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between"><div><p class="text-xs text-gray-500 mb-1">رافقتهم سابقاً</p><p class="text-2xl font-bold">${pastAccompaniedCount}</p></div><div class="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center"><i class="ph-fill ph-hand-heart icon-std"></i></div></div></div><div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4"><div class="flex gap-4 items-center w-full md:w-auto"><div class="flex p-1 bg-gray-100 rounded-lg border border-gray-200"><button onclick="setAppFilter('upcoming')" class="px-5 py-2 rounded-md text-sm font-bold transition ${state.appointmentFilter === 'upcoming' ? 'bg-white shadow-sm text-saudi-green' : 'text-gray-500'}">القادمة</button><button onclick="setAppFilter('past')" class="px-5 py-2 rounded-md text-sm font-bold transition ${state.appointmentFilter === 'past' ? 'bg-white shadow-sm text-saudi-green' : 'text-gray-500'}">السابقة</button></div><select onchange="setAppPatientFilter(this.value)" class="bg-white border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-saudi-green focus:border-saudi-green block p-2.5"><option value="all" ${state.appointmentPatientFilter === 'all' ? 'selected' : ''}>الجميع</option>${Object.values(state.profiles).map(p => `<option value="${p.id}" ${state.appointmentPatientFilter === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}</select></div><button onclick="openModal('add-appointment')" class="bg-saudi-green hover:bg-green-800 text-white px-5 py-2.5 rounded-lg flex items-center gap-2 shadow-sm transition font-bold w-full md:w-auto justify-center"><i class="ph-bold ph-plus"></i> موعد جديد</button></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${displayedApps.length === 0 ? `<div class="col-span-full text-center py-12 text-gray-400 border border-dashed rounded-xl">لا توجد مواعيد</div>` : displayedApps.map(app => renderAppointmentCard(app)).join('')}</div></div>`;
        }

        // --- Cards ---
        function renderMedicationCard(med, showAdherence) {
            let adherenceHtml = '';
            if (showAdherence && med.history && med.history.length > 0) {
                const total = med.history.length;
                const taken = med.history.filter(h => h.status === 'taken').length;
                const percentage = Math.round((taken / total) * 100);
                const color = percentage >= 80 ? 'border-green-500 text-green-700' : percentage >= 50 ? 'border-yellow-500 text-yellow-700' : 'border-red-500 text-red-700';
                adherenceHtml = `<div class="absolute top-4 left-4 flex flex-col items-center"><div class="progress-circle ${color}" style="border-color: currentColor;"><span class="progress-circle-value">${percentage}%</span></div><span class="text-[10px] text-gray-400 mt-1">التزام</span></div>`;
            }
            return `
            <div class="service-card group border-t-4 ${med.profileColor.replace('bg-', 'border-')} relative cursor-pointer" onclick="openMedDetails('${med.profileKey}', ${med.id})">
                ${adherenceHtml}
                <div class="flex justify-between items-start mb-2 pr-2">
                    <div>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold ${med.profileColor} text-white gap-1 mb-2"><i class="ph-fill ph-user"></i> ${med.profileName}</span>
                        <h3 class="text-lg font-bold text-gray-900 group-hover:text-saudi-green transition-colors">${med.name}</h3>
                        <p class="text-gray-500 text-sm">${med.type} • ${med.dose}</p>
                    </div>
                </div>
                <div class="bg-gray-50 border border-gray-100 rounded-lg p-2 mb-4 mt-2">
                    <div class="flex justify-between text-xs text-gray-600 mb-1"><span>التكرار: <b>${med.freq}</b></span><span>المتبقي: <b class="${med.stock < 5 ? 'text-red-600' : 'text-green-600'}">${med.stock}</b></span></div>
                    ${med.isPRN ? '<span class="text-[10px] text-blue-600 bg-blue-50 px-2 py-0.5 rounded">عند اللزوم</span>' : `<div class="flex gap-1 mt-1 flex-wrap">${med.times.map(t => `<span class="bg-white border px-1.5 rounded text-[10px]">${t}</span>`).join('')}</div>`}
                </div>
                <div class="border-t border-gray-100 pt-4 grid grid-cols-2 gap-2 mt-auto" onclick="event.stopPropagation()">
                    ${med.taken ? `<button onclick="toggleMedGlobal('${med.profileKey}', ${med.id})" class="col-span-2 py-2 rounded-lg text-sm font-bold bg-white border border-green-500 text-green-700 flex items-center justify-center gap-2 hover:bg-green-50 transition"><i class="ph-bold ph-arrow-u-up-left"></i> تراجع</button>` : `<button onclick="skipMedGlobal('${med.profileKey}', ${med.id})" class="py-2 rounded-lg text-sm font-bold bg-gray-100 text-gray-600 hover:bg-gray-200 transition">تأجيل الجرعة</button><button onclick="toggleMedGlobal('${med.profileKey}', ${med.id})" class="py-2 rounded-lg text-sm font-bold bg-saudi-green text-white hover:bg-green-800 shadow-sm transition">تأكيد</button>`}
                </div>
            </div>`;
        }

        function renderAppointmentCard(app) {
            const needsSand = app.sand === 'مطلوب مرافق' || app.sand === 'لا يوجد'; const imSand = app.sand.includes('أنا'); const isMyAppointment = app.profileType === 'self'; const isPast = new Date(app.date) < new Date();
            return `
            <div class="service-card group border-t-4 ${app.profileColor.replace('bg-', 'border-')} relative">
                <div class="flex justify-between items-start mb-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold ${app.profileColor} text-white gap-1"><i class="ph-fill ph-user"></i> ${app.profileName}</span>${!isPast ? `<button onclick="openModal('edit-appointment', ${app.id}, '${app.profileKey}')" class="text-gray-400 hover:text-saudi-green"><i class="ph-bold ph-pencil-simple"></i></button>` : ''}</div>
                <h3 class="text-lg font-bold text-gray-900 mb-1">${app.clinic || app.hospital}</h3><p class="text-gray-500 text-sm mb-4 line-clamp-2">${app.doctor ? app.doctor + ' - ' : ''}${app.spec}</p>
                <div class="flex flex-wrap gap-2 mb-6 mt-auto"><span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-50 text-blue-700"><i class="ph ph-calendar-blank mr-1 ml-1"></i> ${app.date}</span><span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-50 text-blue-700"><i class="ph ph-clock mr-1 ml-1"></i> ${app.time}</span></div>
                <div class="border-t border-gray-100 pt-4" onclick="event.stopPropagation()">${isMyAppointment ? `<div class="bg-gray-50 text-gray-500 text-center py-2 rounded-lg text-sm font-bold border border-gray-200">موعدك الشخصي</div>` : (isPast ? `<div class="bg-gray-100 text-gray-400 text-center py-2 rounded-lg text-sm">منتهي</div>` : (needsSand ? `<button onclick="toggleSandStatus('${app.profileKey}', ${app.id}, 'volunteer')" class="w-full bg-saudi-green text-white py-2 rounded-lg text-sm font-bold hover:bg-green-800 transition shadow-sm flex items-center justify-center gap-2"><i class="ph-bold ph-hand-waving"></i> أنا سأرافقه</button>` : imSand ? `<div class="flex gap-2"><span class="bg-green-50 text-green-700 px-3 py-2 rounded-lg text-xs font-bold border border-green-200 flex-1 text-center">أنت المرافق</span><button onclick="toggleSandStatus('${app.profileKey}', ${app.id}, 'withdraw')" class="bg-red-50 text-red-600 px-3 py-2 rounded-lg text-xs font-bold hover:bg-red-100 border border-red-200" title="تراجع"><i class="ph-bold ph-arrow-u-up-left"></i></button></div>` : `<div class="bg-gray-50 text-gray-600 px-3 py-2 rounded-lg text-xs font-bold border border-gray-200 text-center">المرافق: ${app.sand}</div>`))}</div>
            </div>`;
        }

        // --- Modals ---
        function openMedDetails(profileKey, medId) { /* existing logic reused */ openModal('med-details', medId, profileKey); /* using specific type below */ 
            const med = state.profiles[profileKey].meds.find(m => m.id === medId);
            const modal = document.getElementById('modal'); const content = document.getElementById('modal-content');
            modal.classList.remove('hidden'); setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10);
            const imgHtml = med.image ? `<img src="${med.image}" class="w-full h-48 object-cover rounded-xl mb-4 border border-gray-200">` : '';
            content.innerHTML = `<div class="p-6">${imgHtml}<div class="flex justify-between items-start mb-6"><div><h3 class="text-2xl font-bold text-gray-900">${med.name}</h3><span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mt-1">${med.type} • ${med.dose}</span></div><button onclick="closeModal()" class="text-gray-400 hover:text-red-500"><i class="ph-bold ph-x icon-std"></i></button></div><div class="space-y-6"><div class="bg-gray-50 p-4 rounded-xl border border-gray-100 grid grid-cols-2 gap-4"><div><p class="text-xs text-gray-500">التكرار</p><p class="font-bold">${med.freq}</p></div><div><p class="text-xs text-gray-500">مدة الاستخدام</p><p class="font-bold">${med.duration}</p></div><div><p class="text-xs text-gray-500">المخزون المتبقي</p><p class="font-bold ${med.stock < 5 ? 'text-red-600' : 'text-green-600'}">${med.stock} / ${med.totalStock}</p></div><div><p class="text-xs text-gray-500">الحالة الصحية</p><p class="font-bold">${med.condition || '-'}</p></div></div>${!med.isPRN ? `<div><h4 class="font-bold mb-2 text-sm">أوقات الجرعات</h4><div class="flex gap-2 flex-wrap">${med.times.map(t => `<span class="bg-white border border-gray-300 px-3 py-1 rounded-lg text-sm">${t}</span>`).join('')}</div></div>` : ''}<div><h4 class="font-bold mb-2 text-sm flex items-center gap-2"><i class="ph-fill ph-info text-blue-600"></i> تعليمات تفويت الجرعة</h4><p class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg border border-blue-100 leading-relaxed">${med.missedInstruction}</p></div>${med.history ? `<div><h4 class="font-bold mb-2 text-sm">سجل الالتزام</h4><div class="max-h-32 overflow-y-auto space-y-2">${med.history.map(h => `<div class="flex justify-between text-xs p-2 bg-gray-50 rounded border border-gray-100"><span>${h.date}</span><span class="${h.status === 'taken' ? 'text-green-600' : 'text-red-600'} font-bold">${h.status === 'taken' ? 'تم الأخذ' : 'تخطي/نسيان'}</span></div>`).join('')}</div></div>` : ''}</div></div>`;
        }

        function openModal(type, id = null, profileKey = null) {
            const modal = document.getElementById('modal'); const content = document.getElementById('modal-content');
            modal.classList.remove('hidden'); setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10);
            
            if (type === 'add-medication') {
                const days = ['السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة'];
                content.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-xl text-saudi-green">إضافة دواء جديد</h3>
                        <button onclick="closeModal()" class="text-gray-400"><i class="ph-bold ph-x"></i></button>
                    </div>
                    <form onsubmit="event.preventDefault(); addNewMed(new FormData(this));" class="space-y-4">
                        <div><label class="text-xs font-bold block mb-1">صورة الدواء</label><input type="file" name="image" accept="image/*" class="w-full border rounded p-2 text-xs"></div>
                        <div><label class="text-xs font-bold block mb-1">اسم الدواء</label><input name="name" class="w-full border rounded p-2" required></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold block mb-1">النوع</label><select name="type" class="w-full border rounded p-2"><option>حبوب</option><option>شراب</option><option>حقن</option></select></div>
                            <div><label class="text-xs font-bold block mb-1">الجرعة</label><input name="dose" class="w-full border rounded p-2" placeholder="500mg"></div>
                        </div>
                        <div class="flex items-center gap-2"><input type="checkbox" id="prn" name="isPRN" onchange="toggleFreqFields(this.checked)"><label for="prn" class="text-sm font-bold">عند اللزوم (PRN)</label></div>
                        <div id="freq-fields">
                            <label class="text-xs font-bold block mb-1">أوقات الجرعات</label>
                            <div id="time-inputs" class="space-y-2 mb-2">
                                <input type="time" name="times" class="w-full border rounded p-2" value="08:00">
                            </div>
                            <button type="button" onclick="addTimeInput()" class="text-xs text-saudi-green font-bold flex items-center gap-1 mb-4"><i class="ph-bold ph-plus"></i> إضافة وقت آخر</button>
                            
                            <div><label class="text-xs font-bold block mb-1">أيام الاستخدام</label><div class="flex flex-wrap gap-2">${days.map(d => `<label class="cursor-pointer"><input type="checkbox" name="days" value="${d}" class="hidden day-checkbox" checked><span class="inline-block px-3 py-1 bg-gray-100 rounded text-xs border border-gray-200">${d}</span></label>`).join('')}</div></div>
                        </div>
                        <div class="flex gap-3 pt-4 border-t border-gray-100"><button type="button" onclick="closeModal()" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded font-bold">إلغاء</button><button class="flex-1 bg-saudi-green text-white py-2 rounded font-bold">حفظ الدواء</button></div>
                    </form>
                </div>`;
            } else if (type === 'add-document') {
                content.innerHTML = `<div class="p-6"><h3 class="font-bold text-xl mb-4 text-saudi-green">إضافة ملف جديد</h3><form onsubmit="event.preventDefault(); addDocument(new FormData(this));" class="space-y-4"><div><label class="text-xs font-bold block mb-1">عنوان الملف</label><input name="title" class="w-full border rounded p-2" required></div><div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold block mb-1">النوع</label><select name="type" class="w-full border rounded p-2"><option value="report">تقرير طبي</option><option value="lab">نتائج مختبر</option><option value="rx">وصفة طبية</option><option value="xray">أشعة</option></select></div><div><label class="text-xs font-bold block mb-1">التاريخ</label><input type="date" name="date" class="w-full border rounded p-2" required></div></div><div><label class="text-xs font-bold block mb-1">الملف (صورة/PDF)</label><input type="file" name="file" class="w-full border rounded p-2 text-xs" required></div><div><label class="text-xs font-bold block mb-1">صاحب الملف</label><select name="owner" class="w-full border rounded p-2">${Object.values(state.profiles).map(p => `<option value="${p.id}">${p.name}</option>`).join('')}</select></div><div class="flex gap-3 pt-4 border-t border-gray-100"><button type="button" onclick="closeModal()" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded font-bold">إلغاء</button><button class="flex-1 bg-saudi-green text-white py-2 rounded font-bold">رفع الملف</button></div></form></div>`;
            } else if (type === 'add-appointment' || type === 'edit-appointment') {
                let data = {sand:'لا يوجد', condition:'عام'};
                if(id) { data = state.profiles[profileKey].appointments.find(a => a.id === id); }
                content.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                         <h3 class="font-bold text-xl text-saudi-green">${id ? 'تعديل الموعد' : 'موعد جديد'}</h3>
                         <button onclick="closeModal()" class="text-gray-400 hover:text-red-500"><i class="ph-bold ph-x icon-std"></i></button>
                    </div>
                    <form onsubmit="event.preventDefault(); saveAppointment(new FormData(this), this);" class="space-y-4">
                        <input type="hidden" name="id" value="${id || ''}">
                        ${!id ? `<div>
                            <label class="text-xs font-bold block mb-1">المريض (صاحب الموعد)</label>
                            <select name="profileKey" class="w-full border rounded p-2">
                                ${Object.keys(state.profiles).map(k => `<option value="${k}" ${k===state.currentProfile ? 'selected' : ''}>${state.profiles[k].name}</option>`).join('')}
                            </select>
                        </div>` : `<input type="hidden" name="profileKey" value="${profileKey}">`}
                        
                        <div><label class="text-xs font-bold block mb-1">المستشفى</label><input name="hospital" value="${data.hospital||''}" class="w-full border rounded p-2" required></div>
                        <div><label class="text-xs font-bold block mb-1">العيادة</label><input name="clinic" value="${data.clinic||''}" class="w-full border rounded p-2" placeholder="مثال: عيادة الأسنان"></div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold block mb-1">التاريخ</label><input type="date" name="date" value="${data.date||''}" class="w-full border rounded p-2" required></div>
                            <div><label class="text-xs font-bold block mb-1">الوقت</label><input type="time" name="time" value="${data.time||''}" class="w-full border rounded p-2" required></div>
                        </div>

                        <div>
                            <label class="text-xs font-bold block mb-1">إرفاق صورة (كرت الموعد/التحويل)</label>
                            <input type="file" name="image" accept="image/*" class="w-full border rounded p-2 text-xs">
                        </div>
                        
                        <button class="w-full bg-saudi-green text-white py-2 rounded font-bold mt-4">حفظ</button>
                    </form>
                </div>`;
            } else if (type === 'add-patient') {
                content.innerHTML = `
                    <div class="p-6">
                        <h3 class="font-bold text-xl mb-4 text-saudi-green">إضافة مريض جديد</h3>
                        <div class="flex gap-2 mb-4 bg-gray-100 p-1 rounded-lg">
                            <button onclick="document.getElementById('link-form').classList.remove('hidden'); document.getElementById('create-form').classList.add('hidden');" class="flex-1 py-2 rounded bg-white shadow text-sm font-bold">ربط حساب</button>
                            <button onclick="document.getElementById('create-form').classList.remove('hidden'); document.getElementById('link-form').classList.add('hidden');" class="flex-1 py-2 rounded text-gray-500 text-sm font-bold">إنشاء ملف (وكيل)</button>
                        </div>
                        
                        <form id="link-form" onsubmit="event.preventDefault(); showToast('تم إرسال طلب الربط'); closeModal();" class="space-y-4">
                            <div><label class="text-xs font-bold block mb-1">رقم الجوال / الهوية</label><input class="w-full border rounded p-2" placeholder="05xxxxxxxx"></div>
                            <button class="w-full bg-saudi-green text-white py-2 rounded font-bold">إرسال طلب</button>
                        </form>

                        <form id="create-form" onsubmit="event.preventDefault(); addProfile(new FormData(this));" class="space-y-4 hidden">
                            <div><label class="text-xs font-bold block mb-1">الاسم</label><input name="name" class="w-full border rounded p-2" required></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold block mb-1">القرابة</label><select name="type" class="w-full border rounded p-2"><option value="الوالد">الوالد</option><option value="الوالدة">الوالدة</option><option value="الابن">الابن</option><option value="الأخت">الأخت</option></select></div>
                                <div><label class="text-xs font-bold block mb-1">الجنس</label><select name="gender" class="w-full border rounded p-2"><option value="male">ذكر</option><option value="female">أنثى</option></select></div>
                            </div>
                            <button class="w-full bg-saudi-green text-white py-2 rounded font-bold">إنشاء الملف</button>
                        </form>
                    </div>`;
            } else if (type === 'add-supporter') {
                content.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-xl text-blue-600">دعوة مساند</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-red-500"><i class="ph-bold ph-x icon-std"></i></button>
                        </div>
                        <p class="text-sm text-gray-500 mb-4">امنح شخصاً آخر صلاحية الوصول لملفك.</p>
                        <form onsubmit="event.preventDefault(); showToast('تم إرسال الدعوة'); closeModal();" class="space-y-4">
                            <div><label class="text-xs font-bold block mb-1">رقم الجوال</label><input class="w-full border rounded p-2" placeholder="05xxxxxxxx"></div>
                            <div>
                                <label class="text-xs font-bold block mb-2">الصلاحيات</label>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" checked> المواعيد</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" checked> الأدوية</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox"> الملف الطبي</label>
                                </div>
                            </div>
                            <button class="w-full bg-blue-600 text-white py-2 rounded font-bold">إرسال الدعوة</button>
                        </form>
                    </div>`;
            } else if (type === 'edit-permissions') {
                const supporter = state.profiles.primary.supporters.find(s => s.id === id);
                content.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-xl text-gray-800">صلاحيات: ${supporter.name}</h3>
                            <button onclick="closeModal()" class="text-gray-400"><i class="ph-bold ph-x"></i></button>
                        </div>
                        <div class="space-y-3 mb-6">
                             <label class="flex items-center gap-2 text-sm p-3 bg-gray-50 rounded border border-gray-100 cursor-pointer"><input type="checkbox" checked class="accent-saudi-green"> عرض المواعيد القادمة</label>
                             <label class="flex items-center gap-2 text-sm p-3 bg-gray-50 rounded border border-gray-100 cursor-pointer"><input type="checkbox" checked class="accent-saudi-green"> إدارة الأدوية</label>
                             <label class="flex items-center gap-2 text-sm p-3 bg-gray-50 rounded border border-gray-100 cursor-pointer"><input type="checkbox" class="accent-saudi-green"> الاطلاع على نتائج التحاليل</label>
                        </div>
                        <button onclick="closeModal(); showToast('تم تحديث الصلاحيات')" class="w-full bg-saudi-green text-white py-2 rounded font-bold">حفظ التغييرات</button>
                    </div>
                `;
            }
        }

        // --- Logic Functions ---
        function toggleFreqFields(isPRN) { document.getElementById('freq-fields').style.display = isPRN ? 'none' : 'block'; }
        function addTimeInput() {
            const container = document.getElementById('time-inputs');
            const div = document.createElement('div');
            div.className = "flex gap-2";
            div.innerHTML = `<input type="time" name="times" class="w-full border rounded p-2"><button type="button" onclick="this.parentElement.remove()" class="text-red-500"><i class="ph-bold ph-trash"></i></button>`;
            container.appendChild(div);
        }
        
        function addNewMed(formData) {
            const profileKey = state.medicationFilter === 'all' ? state.currentProfile : state.medicationFilter;
            const isPRN = formData.get('isPRN') === 'on';
            const selectedDays = [];
            document.querySelectorAll('input[name="days"]:checked').forEach(cb => selectedDays.push(cb.value));
            
            // Handle Multiple Times
            const times = [];
            if(!isPRN) {
                document.querySelectorAll('input[name="times"]').forEach(input => { if(input.value) times.push(input.value); });
            }

            const fileInput = document.querySelector('input[name="image"]');
            const image = fileInput && fileInput.files[0] ? URL.createObjectURL(fileInput.files[0]) : null;
            const freqText = isPRN ? "عند اللزوم" : `${times.length} مرات يومياً`;

            const newMed = { id: Date.now(), name: formData.get('name'), type: formData.get('type'), dose: formData.get('dose'), isPRN: isPRN, freq: freqText, times: times, days: selectedDays.length > 0 ? selectedDays : ["يومياً"], duration: "مستمر", stock: 30, totalStock: 30, taken: false, history: [], missedInstruction: "استشر الطبيب", image: image };
            state.profiles[profileKey].meds.push(newMed);
            saveState(); closeModal(); navigate('medications'); showToast("تم إضافة الدواء");
        }

        function addDocument(formData) {
            const ownerId = formData.get('owner'); const fileInput = document.querySelector('input[name="file"]'); const fileName = fileInput.files[0] ? fileInput.files[0].name : "مستند";
            const newDoc = { id: Date.now(), title: formData.get('title'), type: formData.get('type'), date: formData.get('date'), file: fileName, desc: "مستند جديد" };
            if(!state.profiles[ownerId].documents) state.profiles[ownerId].documents = [];
            state.profiles[ownerId].documents.push(newDoc);
            saveState(); closeModal(); navigate('documents'); showToast("تم رفع الملف");
        }

        function deleteDocument(profileKey, docId) {
            if(confirm("هل أنت متأكد من حذف الملف؟")) {
                const docs = state.profiles[profileKey].documents;
                const index = docs.findIndex(d => d.id === docId);
                if(index > -1) { docs.splice(index, 1); saveState(); navigate('documents'); showToast("تم الحذف"); }
            }
        }
        
        function deleteSupporter(id) {
            if(confirm("هل أنت متأكد من حذف هذا المساند؟")) {
                const idx = state.profiles.primary.supporters.findIndex(s => s.id === id);
                if(idx > -1) {
                    state.profiles.primary.supporters.splice(idx, 1);
                    saveState(); navigate('sands'); showToast("تم حذف المساند");
                }
            }
        }

        function addProfile(formData) {
            const name = formData.get('name'); const type = formData.get('type'); const gender = formData.get('gender'); 
            const id = 'profile_' + Date.now();
            const colors = ['bg-indigo-600', 'bg-orange-500', 'bg-blue-600', 'bg-purple-600'];
            state.profiles[id] = { id: id, type: 'proxy', name: `${name} (${type})`, relation: type, gender: gender, color: gender === 'female' ? 'bg-pink-600' : 'bg-blue-600', meds: [], appointments: [], documents: [] };
            saveState(); closeModal(); switchProfile(id); showToast('تم إنشاء الملف الجديد');
        }

        function acceptRequest(reqId) {
            const reqIndex = state.profiles.primary.supporterRequests.findIndex(r => r.id === reqId);
            if(reqIndex > -1) {
                const req = state.profiles.primary.supporterRequests[reqIndex];
                state.profiles.primary.supporters.push({id: req.id, name: req.name, relation: req.relation, access: ["صلاحية مخصصة"]});
                state.profiles.primary.supporterRequests.splice(reqIndex, 1);
                saveState(); navigate('sands'); showToast("تم قبول الطلب");
            }
        }

        function rejectRequest(reqId) {
            const reqIndex = state.profiles.primary.supporterRequests.findIndex(r => r.id === reqId);
            if(reqIndex > -1) {
                state.profiles.primary.supporterRequests.splice(reqIndex, 1);
                saveState(); navigate('sands'); showToast("تم رفض الطلب");
            }
        }

        function setDocFilter(val) { state.documentFilter = val; navigate('documents'); }
        function toggleDocSort() { state.documentSort = state.documentSort === 'newest' ? 'oldest' : 'newest'; navigate('documents'); }
        function setMedFilter(val) { state.medicationFilter = val; navigate('medications'); }
        function setAppPatientFilter(val) { state.appointmentPatientFilter = val; navigate('appointments'); }
        function setAppFilter(val) { state.appointmentFilter = val; navigate('appointments'); }
        
        function saveAppointment(formData, formEl) { 
            const id = formData.get('id');
            const pKey = formData.get('profileKey');
            const data = { 
                id: id ? parseInt(id) : Date.now(), 
                hospital: formData.get('hospital'), 
                clinic: formData.get('clinic'),
                date: formData.get('date'), 
                time: formData.get('time'), 
                doctor: "طبيب", spec: "عام", sand: "لا يوجد", condition: "عام", done: false 
            }; 
            
            if(id) { 
                const idx = state.profiles[pKey].appointments.findIndex(a => a.id == id); 
                if(idx !== -1) state.profiles[pKey].appointments[idx] = {...state.profiles[pKey].appointments[idx], ...data}; 
            } else { 
                state.profiles[pKey].appointments.push(data); 
            } 
            saveState(); closeModal(); navigate('appointments'); showToast("تم الحفظ"); 
        }

        function toggleSandStatus(profileKey, appId, action) { const app = state.profiles[profileKey].appointments.find(a => a.id === appId); app.sand = action === 'volunteer' ? `أنا (${state.currentUser})` : "مطلوب مرافق"; saveState(); navigate('appointments'); showToast(action === 'volunteer' ? "تم تسجيلك كمرافق" : "تم التراجع"); }
        function toggleMedGlobal(profileKey, medId) { const med = state.profiles[profileKey].meds.find(m => m.id === medId); med.taken = !med.taken; if(med.taken) med.history.push({date: new Date().toISOString().split('T')[0], status: 'taken'}); else med.history.pop(); saveState(); const currentView = document.querySelector('.nav-link.active').dataset.target; navigate(currentView); showToast(med.taken ? "تم تأكيد الجرعة" : "تم التراجع عن الجرعة"); }
        function skipMedGlobal(profileKey, medId) { const med = state.profiles[profileKey].meds.find(m => m.id === medId); med.history.push({date: new Date().toISOString().split('T')[0], status: 'missed'}); saveState(); navigate('medications'); showToast("تم تأجيل الجرعة"); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        function triggerSOS() { if(confirm("تأكيد؟")) showToast("جاري الإرسال..."); }
        function showToast(msg) { const t=document.getElementById('toast'); document.getElementById('toast-message').innerText=msg; t.classList.remove('opacity-0','translate-y-[-20px]'); setTimeout(()=>t.classList.add('opacity-0','translate-y-[-20px]'),3000); }
        function toggleNotifications() { document.getElementById('notification-panel').classList.toggle('open'); }
        function renderNotifications() { document.getElementById('notifications-list').innerHTML = `<div class="alert-card"><div class="alert-strip orange"></div><div class="alert-content"><div class="alert-flex"><div class="alert-icon-wrapper text-alert-orange"><i class="ph-bold ph-pill"></i></div><div><h4 class="alert-title">اقتراب نفاذ دواء</h4><p class="alert-desc">دواء Metformin للوالد قارب على الانتهاء</p></div></div></div></div>`; }
        function switchProfile(key) { state.currentProfile = key; saveState(); navigate('dashboard'); }
        
        // --- ADDED FUNCTIONS FOR PROFILE HEADER ---
        function renderProfileDropdown() {
             const list = document.getElementById('profile-dropdown');
             list.innerHTML = Object.values(state.profiles).map(p => `
                <button onclick="switchProfile('${p.id}')" class="w-full text-right flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg transition ${state.currentProfile === p.id ? 'bg-gray-50 ring-1 ring-gray-200' : ''}">
                    <div class="w-10 h-10 rounded-full ${p.color} text-white flex items-center justify-center font-bold shadow-sm">${p.name.charAt(0)}</div>
                    <div>
                        <p class="font-bold text-gray-800 text-sm">${p.name}</p>
                        <p class="text-xs text-gray-500">${p.relation} ${p.role === 'sanad' ? '(مساند)' : ''}</p>
                    </div>
                    ${state.currentProfile === p.id ? '<i class="ph-fill ph-check-circle text-saudi-green mr-auto"></i>' : ''}
                </button>
            `).join('') + `<div class="border-t border-gray-100 mt-2 pt-2"><button onclick="openModal('add-patient')" class="w-full text-right flex items-center gap-2 p-2 text-sm font-bold text-saudi-green hover:bg-green-50 rounded-lg"><i class="ph-bold ph-plus"></i> إضافة مريض جديد</button></div>`;
        }

        function updateHeader() {
            const profile = state.profiles[state.currentProfile];
            if(profile) {
                document.getElementById('user-greeting-header').innerText = profile.name;
                const iconDiv = document.getElementById('current-profile-icon');
                iconDiv.innerText = profile.name.charAt(0);
                iconDiv.className = `w-8 h-8 rounded-full ${profile.color} text-white flex items-center justify-center font-bold text-sm`;
            }
        }
        
        function quickAdd() { openModal('add-appointment'); }
    </script>
</body>
</html>
